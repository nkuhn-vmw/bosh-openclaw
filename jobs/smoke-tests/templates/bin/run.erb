#!/bin/bash

set -eu
export PATH="/var/vcap/packages/cf-cli/bin:${PATH}"

CF_API="<%= p('cf.api_url') %>"
CF_USER="<%= p('cf.admin_username') %>"
CF_PASSWORD="<%= p('cf.admin_password') %>"
SMOKE_ORG="<%= p('smoke_tests.org') %>"
SMOKE_SPACE="<%= p('smoke_tests.space') %>"
PLAN="<%= p('smoke_tests.plan') %>"
TIMEOUT="<%= p('smoke_tests.timeout_seconds') %>"
VERIFY_ROUTE="<%= p('smoke_tests.verify_webchat_route') %>"

SSL_FLAG=""
<% if p('cf.skip_ssl_validation') %>
SSL_FLAG="--skip-ssl-validation"
<% end %>

SERVICE_INSTANCE="smoke-test-agent"
SERVICE_KEY="smoke-key"

cleanup() {
  echo ""
  echo "=== Cleanup ==="
  cf delete-service-key "${SERVICE_INSTANCE}" "${SERVICE_KEY}" -f 2>/dev/null || true
  cf delete-service "${SERVICE_INSTANCE}" -f 2>/dev/null || true

  # Wait for service deletion to complete
  local elapsed=0
  while [ $elapsed -lt $TIMEOUT ]; do
    if ! cf service "${SERVICE_INSTANCE}" 2>/dev/null | grep -q "delete in progress"; then
      break
    fi
    sleep 5
    elapsed=$((elapsed + 5))
  done

  cf delete-org "${SMOKE_ORG}" -f 2>/dev/null || true
  echo "Cleanup complete."
}
trap cleanup EXIT

echo "=== OpenClaw Smoke Tests ==="
echo ""

# [1/7] Login
echo "[1/7] Logging in to Cloud Foundry..."
cf api "${CF_API}" ${SSL_FLAG}
cf auth "${CF_USER}" "${CF_PASSWORD}"

# [2/7] Create org/space
echo "[2/7] Creating smoke test org and space..."
cf create-org "${SMOKE_ORG}" 2>/dev/null || true
cf target -o "${SMOKE_ORG}"
cf create-space "${SMOKE_SPACE}" 2>/dev/null || true
cf target -s "${SMOKE_SPACE}"

# [3/7] Verify marketplace
echo "[3/7] Verifying openclaw service in marketplace..."
MARKETPLACE=$(cf marketplace -e openclaw 2>&1)
if ! echo "${MARKETPLACE}" | grep -q "openclaw"; then
  echo "FAIL: openclaw service not found in marketplace"
  exit 1
fi
echo "PASS: openclaw service found in marketplace"

<% if p('smoke_tests.lifecycle_test') %>
# --- Full lifecycle test (requires real packages) ---

# Auto-detect plan if configured plan is not available
if [ -n "${PLAN}" ] && echo "${MARKETPLACE}" | grep -q "^[[:space:]]*${PLAN}[[:space:]]"; then
  echo "Using configured plan: ${PLAN}"
else
  # Pick the first available plan from marketplace output
  # cf marketplace -e openclaw indents plan rows with spaces; skip the "plan" header row
  DETECTED_PLAN=$(echo "${MARKETPLACE}" | awk '/^[ \t]+[a-z]/ && $1 != "plan" {print $1; exit}')
  if [ -n "${DETECTED_PLAN}" ]; then
    echo "Configured plan '${PLAN}' not found, using first available plan: ${DETECTED_PLAN}"
    PLAN="${DETECTED_PLAN}"
  else
    echo "FAIL: No service plans available for openclaw"
    exit 1
  fi
fi

# Clean up any leftover instance from a previous failed run
if cf service "${SERVICE_INSTANCE}" 2>/dev/null | grep -q "${SERVICE_INSTANCE}"; then
  echo "Found leftover instance '${SERVICE_INSTANCE}', purging..."
  cf purge-service-instance "${SERVICE_INSTANCE}" -f 2>/dev/null || true
  sleep 5
fi

# [4/7] Create service instance
echo "[4/7] Creating service instance (plan: ${PLAN})..."
cf create-service openclaw "${PLAN}" "${SERVICE_INSTANCE}"
echo "Service instance creation initiated."

# [5/7] Wait for provisioning
echo "[5/7] Waiting for provisioning to complete (timeout: ${TIMEOUT}s)..."
elapsed=0
while [ $elapsed -lt $TIMEOUT ]; do
  status=$(cf service "${SERVICE_INSTANCE}" 2>&1)
  if echo "${status}" | grep -q "create succeeded"; then
    echo "PASS: Service instance provisioned successfully"
    break
  fi
  if echo "${status}" | grep -q "create failed"; then
    echo "FAIL: Service instance provisioning failed"
    echo "${status}"
    exit 1
  fi
  sleep 10
  elapsed=$((elapsed + 10))
  echo "  ...waiting (${elapsed}s / ${TIMEOUT}s)"
done

if [ $elapsed -ge $TIMEOUT ]; then
  echo "FAIL: Timed out waiting for service instance to provision"
  cf service "${SERVICE_INSTANCE}"
  exit 1
fi

# [6/7] Validate service key
echo "[6/7] Validating service key credentials..."
cf create-service-key "${SERVICE_INSTANCE}" "${SERVICE_KEY}"
KEY_OUTPUT=$(cf service-key "${SERVICE_INSTANCE}" "${SERVICE_KEY}" 2>&1)

# Extract JSON portion (skip the first two header lines from cf service-key output)
KEY_JSON=$(echo "${KEY_OUTPUT}" | sed '1,2d')

FAILED=0
for field in webchat_url gateway_token instance_id; do
  if ! echo "${KEY_JSON}" | grep -q "\"${field}\""; then
    echo "FAIL: Service key missing expected field: ${field}"
    FAILED=1
  fi
done

if [ $FAILED -eq 1 ]; then
  echo "Service key output:"
  echo "${KEY_JSON}"
  exit 1
fi
echo "PASS: Service key contains expected credential fields"

# [7/7] Verify webchat route (conditional)
<% if p('smoke_tests.verify_webchat_route') %>
echo "[7/7] Verifying webchat route..."
WEBCHAT_URL=$(echo "${KEY_JSON}" | grep '"webchat_url"' | sed 's/.*: *"\(.*\)".*/\1/' | sed 's/,$//')

if [ -z "${WEBCHAT_URL}" ]; then
  echo "FAIL: Could not extract webchat_url from service key"
  exit 1
fi

HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 30 ${SSL_FLAG:+--insecure} "${WEBCHAT_URL}" || echo "000")

if [ "${HTTP_CODE}" = "200" ]; then
  echo "PASS: WebChat UI is accessible (HTTP ${HTTP_CODE})"
else
  echo "WARN: WebChat UI returned HTTP ${HTTP_CODE} (may still be starting up)"
fi
<% else %>
echo "[7/7] Skipping webchat route verification (disabled)."
<% end %>
<% else %>
# --- Marketplace-only test (default for stub packages) ---
echo "[4/4] Counting available plans..."
PLAN_COUNT=$(echo "${MARKETPLACE}" | awk '/^[ \t]+[a-z]/ && $1 != "plan" {count++} END {print count+0}')
echo "PASS: Found ${PLAN_COUNT} plan(s) in marketplace"
<% end %>

echo ""
echo "=== All smoke tests passed ==="
