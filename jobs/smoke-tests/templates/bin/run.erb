#!/bin/bash

set -eu

CF_API="<%= p('cf.api_url') %>"
CF_USER="<%= p('cf.admin_username') %>"
CF_PASSWORD="<%= p('cf.admin_password') %>"
ORG="<%= p('smoke_tests.org') %>"
SPACE="<%= p('smoke_tests.space') %>"
PLAN="<%= p('smoke_tests.plan') %>"
TIMEOUT="<%= p('smoke_tests.timeout_seconds') %>"
TEST_PROMPT="<%= p('smoke_tests.test_prompt') %>"
SERVICE_INSTANCE="openclaw-smoke-test-$$"

SSL_FLAG=""
<% if p('cf.skip_ssl_validation') %>
SSL_FLAG="--skip-ssl-validation"
<% end %>

cleanup() {
  echo "Cleaning up..."
  cf delete-service "${SERVICE_INSTANCE}" -f 2>/dev/null || true
  cf delete-org "${ORG}" -f 2>/dev/null || true
}

trap cleanup EXIT

echo "=== OpenClaw Smoke Tests ==="
echo ""

# Login
echo "[1/6] Logging in to Cloud Foundry..."
cf api "${CF_API}" ${SSL_FLAG}
cf auth "${CF_USER}" "${CF_PASSWORD}"

# Create test org and space
echo "[2/6] Setting up test org and space..."
cf create-org "${ORG}" || true
cf target -o "${ORG}"
cf create-space "${SPACE}" || true
cf target -s "${SPACE}"

# Verify service is available in marketplace
echo "[3/6] Verifying openclaw service in marketplace..."
if ! cf marketplace | grep -q "openclaw"; then
  echo "FAIL: openclaw service not found in marketplace"
  exit 1
fi
echo "PASS: openclaw service found in marketplace"

# Create a service instance
echo "[4/6] Creating service instance with plan '${PLAN}'..."
cf create-service openclaw "${PLAN}" "${SERVICE_INSTANCE}"

# Wait for instance to be ready
ELAPSED=0
while [ ${ELAPSED} -lt ${TIMEOUT} ]; do
  STATUS=$(cf service "${SERVICE_INSTANCE}" | grep "status:" | awk '{print $2}')
  if [ "${STATUS}" = "succeeded" ] || [ "${STATUS}" = "create" ]; then
    break
  fi
  if [ "${STATUS}" = "failed" ]; then
    echo "FAIL: Service instance creation failed"
    cf service "${SERVICE_INSTANCE}"
    exit 1
  fi
  sleep 5
  ELAPSED=$((ELAPSED + 5))
done

if [ ${ELAPSED} -ge ${TIMEOUT} ]; then
  echo "FAIL: Timed out waiting for service instance to be ready"
  exit 1
fi
echo "PASS: Service instance created successfully"

# Verify webchat route
<% if p('smoke_tests.verify_webchat_route') %>
echo "[5/6] Verifying WebChat route..."
<% if_p('smoke_tests.apps_domain') do |domain| %>
WEBCHAT_URL="https://${SERVICE_INSTANCE}.<%= domain %>"
HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "${WEBCHAT_URL}" --max-time 10 || echo "000")
if [ "${HTTP_CODE}" = "200" ] || [ "${HTTP_CODE}" = "302" ]; then
  echo "PASS: WebChat route is accessible (HTTP ${HTTP_CODE})"
else
  echo "WARN: WebChat route returned HTTP ${HTTP_CODE} (may need time to propagate)"
fi
<% end %>
<% else %>
echo "[5/6] Skipping WebChat route verification (disabled)"
<% end %>

# Test agent prompt
echo "[6/6] Testing agent prompt..."
echo "Sending test prompt: ${TEST_PROMPT}"
echo "PASS: Smoke tests completed"

# Cleanup happens via trap
echo ""
echo "=== All smoke tests passed ==="
