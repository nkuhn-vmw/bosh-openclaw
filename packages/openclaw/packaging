set -e
export PATH=/var/vcap/packages/node22/bin:$PATH
export HOME=/var/vcap

mkdir -p ${BOSH_INSTALL_TARGET}/lib
tar xzf ${BOSH_COMPILE_TARGET}/openclaw/openclaw-*.tgz \
  -C ${BOSH_INSTALL_TARGET}/lib/

mkdir -p ${BOSH_INSTALL_TARGET}/lib/skills
tar xzf ${BOSH_COMPILE_TARGET}/openclaw/skills-bundle-*.tgz \
  -C ${BOSH_INSTALL_TARGET}/lib/skills/

# Ensure all extracted files are readable by vcap (BPM runs as vcap)
chmod -R a+rX ${BOSH_INSTALL_TARGET}/lib

PKG_DIR=${BOSH_INSTALL_TARGET}/lib/node_modules/openclaw

# Verify the entry point loads on this platform during compilation
echo "=== Verifying openclaw entry point ==="
echo "Node.js version: $(node --version)"
echo "Package dir: ${PKG_DIR}"
ls -la "${PKG_DIR}/dist/entry.js" 2>&1 || echo "dist/entry.js NOT FOUND"
ls -la "${PKG_DIR}/openclaw.mjs" 2>&1 || echo "openclaw.mjs NOT FOUND"
echo "package.json type field: $(node -e "console.log(require('${PKG_DIR}/package.json').type || 'undefined')")"

cd "${PKG_DIR}"
echo "--- Testing: node ./openclaw.mjs --version ---"
node ./openclaw.mjs --version 2>&1 || {
  echo "ERROR: openclaw.mjs failed (exit $?)"
  echo "Trying dist/entry.js..."
  node ./dist/entry.js --version 2>&1 || {
    echo "ERROR: dist/entry.js also failed (exit $?)"
    exit 1
  }
}
echo "=== Entry point verified ==="
cd "${BOSH_COMPILE_TARGET}"

# Create bin wrapper that invokes openclaw.mjs directly as ESM.
# The CJS bootstrap (dynamic import()) stopped working in openclaw 2026.2.23
# because the ESM entry now uses top-level await and import.meta checks
# that don't fire correctly when loaded via dynamic import() from CJS.
mkdir -p ${BOSH_INSTALL_TARGET}/bin
cat > ${BOSH_INSTALL_TARGET}/bin/openclaw <<'WRAPPER'
#!/bin/bash
export PATH=/var/vcap/packages/node22/bin:$PATH
exec node /var/vcap/packages/openclaw/lib/node_modules/openclaw/openclaw.mjs "$@"
WRAPPER
chmod +x ${BOSH_INSTALL_TARGET}/bin/openclaw
