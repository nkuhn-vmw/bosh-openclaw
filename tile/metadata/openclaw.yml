---
name: openclaw
product_version: "VERSION_PLACEHOLDER"
metadata_version: "3.0"
label: OpenClaw AI Agent Platform
description: Deploy dedicated OpenClaw AI agents for developers and teams
icon_image: ICON_BASE64_PLACEHOLDER

minimum_version_for_upgrade: "0.0.1"
serial: true
rank: 1

service_broker: true

requires_product_versions:
  - name: cf
    version: "~> 4.0"

stemcell_criteria:
  os: ubuntu-jammy
  version: "1.0"

releases:
  - name: openclaw
    version: "VERSION_PLACEHOLDER"
    file: openclaw-release-VERSION_PLACEHOLDER.tgz
    sha1: SHA1_PLACEHOLDER
  - name: bpm
    version: "1.1.21"
    file: bpm-1.1.21.tgz
    sha1: BPM_SHA1_PLACEHOLDER
  - name: routing
    version: "0.283.0"
    file: routing-0.283.0.tgz
    sha1: ROUTING_SHA1_PLACEHOLDER

# ---------------------------------------------------------------------------
# Property Blueprints
# ---------------------------------------------------------------------------

property_blueprints:

  #
  # Auto-generated broker credentials (not exposed to user)
  #
  - name: generated_broker_credentials
    type: simple_credentials

  - name: generated_sso_cookie_secret
    type: simple_credentials

  #
  # GenAI / LLM provider selector
  #
  - name: genai_provider
    type: selector
    configurable: true
    default: "Tanzu GenAI Service"
    option_templates:
      - name: tanzu_genai
        select_value: "Tanzu GenAI Service"
        named_manifests:
          - name: genai_fragment
            manifest: |
              provider: tanzu_genai
              offering_name: (( .properties.genai_provider.tanzu_genai.offering_name.value ))
              plan_name: (( .properties.genai_provider.tanzu_genai.plan_name.value ))
        property_blueprints:
          - name: offering_name
            type: string
            configurable: true
            optional: false
          - name: plan_name
            type: string
            configurable: true
            optional: false
      - name: anthropic_direct
        select_value: "Anthropic (Direct)"
        named_manifests:
          - name: genai_fragment
            manifest: |
              provider: anthropic
              api_key: (( .properties.genai_provider.anthropic_direct.api_key.value ))
              model: (( .properties.genai_provider.anthropic_direct.model.value ))
        property_blueprints:
          - name: api_key
            type: secret
            configurable: true
            optional: false
          - name: model
            type: dropdown_select
            configurable: true
            default: "claude-sonnet-4-5-20250929"
            options:
              - name: "claude-opus-4-6"
                label: "Claude Opus 4.6"
              - name: "claude-sonnet-4-5-20250929"
                label: "Claude Sonnet 4.5"
              - name: "claude-haiku-4-5-20251001"
                label: "Claude Haiku 4.5"
      - name: openai_direct
        select_value: "OpenAI (Direct)"
        named_manifests:
          - name: genai_fragment
            manifest: |
              provider: openai
              api_key: (( .properties.genai_provider.openai_direct.api_key.value ))
              model: (( .properties.genai_provider.openai_direct.model.value ))
        property_blueprints:
          - name: api_key
            type: secret
            configurable: true
            optional: false
          - name: model
            type: string
            configurable: true
            default: "gpt-4o"
            optional: true
      - name: external_openai
        select_value: "External OpenAI API"
        named_manifests:
          - name: genai_fragment
            manifest: |
              provider: external_openai
              api_endpoint: (( .properties.genai_provider.external_openai.api_endpoint.value ))
              api_key: (( .properties.genai_provider.external_openai.api_key.value ))
              model: (( .properties.genai_provider.external_openai.model.value ))
        property_blueprints:
          - name: api_endpoint
            type: string
            configurable: true
            optional: false
          - name: api_key
            type: secret
            configurable: true
            optional: false
          - name: model
            type: string
            configurable: true
            default: "gpt-4o"
            optional: true

  #
  # Security controls
  #
  - name: sandbox_mode
    type: dropdown_select
    configurable: true
    default: "strict"
    options:
      - name: "strict"
        label: "Strict - All commands require explicit approval"
      - name: "moderate"
        label: "Moderate - Common commands allowed, destructive blocked"
      - name: "loose"
        label: "Loose - Most commands allowed (not recommended)"

  - name: control_ui_enabled
    type: boolean
    configurable: true
    default: false

  - name: blocked_commands
    type: text
    configurable: true
    default: "rm -rf /\ndd if=/dev/zero\nmkfs\ncurl\nwget"
    optional: true

  - name: min_openclaw_version
    type: string
    configurable: true
    default: "2026.1.29"
    optional: true

  #
  # Skills management
  #
  - name: skills_mode
    type: dropdown_select
    configurable: true
    default: "allowlist"
    options:
      - name: "allowlist"
        label: "Allowlist - Only approved skills"
      - name: "blocklist"
        label: "Blocklist - All except blocked"
      - name: "disabled"
        label: "Disabled - Built-in tools only"

  - name: approved_skills
    type: text
    configurable: true
    default: |
      weather
      calendar-google
      email-gmail
      github
      jira
      slack-actions
      notion
    optional: true

  - name: auto_sync_from_clawhub
    type: boolean
    configurable: true
    default: true

  - name: scan_skills_on_sync
    type: boolean
    configurable: true
    default: true

  #
  # SSO / Authentication
  #
  - name: sso_enabled
    type: boolean
    configurable: true
    default: true

  - name: sso_plan
    type: string
    configurable: true
    default: "uaa"
    optional: true

  - name: sso_allowed_email_domains
    type: text
    configurable: true
    optional: true

  - name: sso_client_id
    type: string
    configurable: true
    optional: true

  - name: sso_client_secret
    type: secret
    configurable: true
    optional: true

  - name: sso_session_timeout_hours
    type: integer
    configurable: true
    default: 8

  # On-demand agent AZ (populated from service network AZs)
  - name: on_demand_az
    type: service_network_az_multi_select
    configurable: true

  #
  # Service plans — Developer
  #
  - name: developer_plan_enabled
    type: boolean
    configurable: true
    default: true

  - name: developer_plan_description
    type: string
    configurable: true
    default: "Single-user AI agent for individual developers"
    optional: true

  - name: developer_plan_vm_type
    type: vm_type_dropdown
    configurable: true

  - name: developer_plan_disk_type
    type: disk_type_dropdown
    configurable: true

  - name: developer_plan_browser_automation
    type: boolean
    configurable: true
    default: false

  - name: developer_plan_max_sessions
    type: integer
    configurable: true
    default: 1
    constraints:
      min: 1
      max: 10

  #
  # Service plans — Developer Plus
  #
  - name: developer_plus_plan_enabled
    type: boolean
    configurable: true
    default: true

  - name: developer_plus_plan_description
    type: string
    configurable: true
    default: "Enhanced agent with browser automation and larger workspace"
    optional: true

  - name: developer_plus_plan_vm_type
    type: vm_type_dropdown
    configurable: true

  - name: developer_plus_plan_disk_type
    type: disk_type_dropdown
    configurable: true

  - name: developer_plus_plan_browser_automation
    type: boolean
    configurable: true
    default: true

  - name: developer_plus_plan_max_sessions
    type: integer
    configurable: true
    default: 3
    constraints:
      min: 1
      max: 10

  #
  # Service plans — Team
  #
  - name: team_plan_enabled
    type: boolean
    configurable: true
    default: false

  - name: team_plan_description
    type: string
    configurable: true
    default: "Multi-user shared agent for team collaboration"
    optional: true

  - name: team_plan_vm_type
    type: vm_type_dropdown
    configurable: true

  - name: team_plan_disk_type
    type: disk_type_dropdown
    configurable: true

  - name: team_plan_browser_automation
    type: boolean
    configurable: true
    default: true

  - name: team_plan_max_sessions
    type: integer
    configurable: true
    default: 5
    constraints:
      min: 1
      max: 10

  #
  # Service broker limits
  #
  - name: max_instances
    type: integer
    configurable: true
    default: 50

  - name: max_instances_per_org
    type: integer
    configurable: true
    default: 10

  #
  # Agent Networking
  #
  - name: broker_route_prefix
    type: string
    configurable: true
    default: "openclaw-broker"
    optional: true

  - name: dashboard_route_prefix
    type: string
    configurable: true
    default: "openclaw-admin"
    optional: true

  - name: agent_route_prefix
    type: string
    configurable: true
    default: "openclaw"
    optional: true

# ---------------------------------------------------------------------------
# Form Types
# ---------------------------------------------------------------------------

form_types:

  - name: genai-config
    label: GenAI / LLM Configuration
    description: Configure the LLM provider for all OpenClaw agents
    property_inputs:
      - reference: .properties.genai_provider
        label: LLM Provider
        selector_property_inputs:
          - reference: .properties.genai_provider.tanzu_genai
            label: Tanzu GenAI Service
            property_inputs:
              - reference: .properties.genai_provider.tanzu_genai.offering_name
                label: GenAI Offering Name
                description: Name of the GenAI service offering in the marketplace
              - reference: .properties.genai_provider.tanzu_genai.plan_name
                label: GenAI Plan Name
                description: Plan name for the GenAI service instance
          - reference: .properties.genai_provider.anthropic_direct
            label: Anthropic (Direct)
            property_inputs:
              - reference: .properties.genai_provider.anthropic_direct.api_key
                label: Anthropic API Key
              - reference: .properties.genai_provider.anthropic_direct.model
                label: Model
          - reference: .properties.genai_provider.openai_direct
            label: OpenAI (Direct)
            property_inputs:
              - reference: .properties.genai_provider.openai_direct.api_key
                label: OpenAI API Key
              - reference: .properties.genai_provider.openai_direct.model
                label: Model
          - reference: .properties.genai_provider.external_openai
            label: External OpenAI API
            property_inputs:
              - reference: .properties.genai_provider.external_openai.api_endpoint
                label: API Endpoint URL
                description: Base URL of the OpenAI-compatible API (e.g., https://api.openai.com)
              - reference: .properties.genai_provider.external_openai.api_key
                label: API Key
              - reference: .properties.genai_provider.external_openai.model
                label: Model

  - name: security-config
    label: Security & Compliance
    description: Enterprise security controls for all agent instances
    property_inputs:
      - reference: .properties.sandbox_mode
        label: Sandbox Mode
      - reference: .properties.control_ui_enabled
        label: Enable Control UI
        description: >
          WARNING: The Control UI was the attack vector for CVE-2026-25253.
          Enable only on patched versions with auth required.
      - reference: .properties.blocked_commands
        label: Blocked Shell Commands
        description: One command per line
      - reference: .properties.min_openclaw_version
        label: Minimum OpenClaw Version
        description: Refuse to deploy agents below this version

  - name: skills-config
    label: Skills Management
    description: Control which skills are available to agents
    property_inputs:
      - reference: .properties.skills_mode
        label: Skills Policy
      - reference: .properties.approved_skills
        label: Approved Skills
        description: One skill name per line
      - reference: .properties.auto_sync_from_clawhub
        label: Auto-sync from ClawHub
      - reference: .properties.scan_skills_on_sync
        label: Security Scan Skills on Sync

  - name: sso-config
    label: SSO / Authentication
    description: Configure Single Sign-On for agent WebChat instances
    property_inputs:
      - reference: .properties.sso_enabled
        label: Enable SSO for Agent Instances
        description: Each agent WebChat UI is protected by SSO via p-identity
      - reference: .properties.sso_client_id
        label: SSO OAuth2 Client ID
        description: OAuth2 client ID for agent SSO proxy (from UAA or p-identity)
      - reference: .properties.sso_client_secret
        label: SSO OAuth2 Client Secret
        description: OAuth2 client secret for agent SSO proxy
      - reference: .properties.sso_plan
        label: p-identity Service Plan
      - reference: .properties.sso_allowed_email_domains
        label: Allowed Email Domains
        description: One per line (e.g., example.com). Empty = all authenticated users
      - reference: .properties.sso_session_timeout_hours
        label: Session Timeout (hours)

  - name: plan-config
    label: Service Plans
    description: Configure on-demand agent plans available in the CF marketplace
    property_inputs:
      - reference: .properties.on_demand_az
        label: AZs to deploy agent instances
        description: >
          AZs of the service network (configured in the Ops Manager Director tile).
          If multiple AZs are selected then new instances will be distributed randomly between them.
      - reference: .properties.developer_plan_enabled
        label: Enable Developer Plan
      - reference: .properties.developer_plan_description
        label: Developer Plan Description
      - reference: .properties.developer_plan_vm_type
        label: Developer Plan VM Type
      - reference: .properties.developer_plan_disk_type
        label: Developer Plan Disk Type
      - reference: .properties.developer_plan_browser_automation
        label: Developer Plan — Browser Automation
      - reference: .properties.developer_plan_max_sessions
        label: Developer Plan — Max Concurrent Sessions
      - reference: .properties.developer_plus_plan_enabled
        label: Enable Developer Plus Plan
      - reference: .properties.developer_plus_plan_description
        label: Developer Plus Plan Description
      - reference: .properties.developer_plus_plan_vm_type
        label: Developer Plus Plan VM Type
      - reference: .properties.developer_plus_plan_disk_type
        label: Developer Plus Plan Disk Type
      - reference: .properties.developer_plus_plan_browser_automation
        label: Developer Plus Plan — Browser Automation
      - reference: .properties.developer_plus_plan_max_sessions
        label: Developer Plus Plan — Max Concurrent Sessions
      - reference: .properties.team_plan_enabled
        label: Enable Team Plan
      - reference: .properties.team_plan_description
        label: Team Plan Description
      - reference: .properties.team_plan_vm_type
        label: Team Plan VM Type
      - reference: .properties.team_plan_disk_type
        label: Team Plan Disk Type
      - reference: .properties.team_plan_browser_automation
        label: Team Plan — Browser Automation
      - reference: .properties.team_plan_max_sessions
        label: Team Plan — Max Concurrent Sessions
      - reference: .properties.max_instances
        label: Maximum Total Instances
      - reference: .properties.max_instances_per_org
        label: Maximum Instances Per Org

  - name: networking-config
    label: Agent Networking
    description: Route and network configuration for agent instances
    property_inputs:
      - reference: .properties.broker_route_prefix
        label: Broker Route Prefix
        description: "Route prefix for the service broker (e.g., openclaw-broker → openclaw-broker.<apps-domain>)"
      - reference: .properties.dashboard_route_prefix
        label: Dashboard Route Prefix
        description: "Route prefix for the admin dashboard (e.g., openclaw-admin → openclaw-admin.<apps-domain>)"
      - reference: .properties.agent_route_prefix
        label: Agent Route Prefix
        description: "Route prefix for agent instances (e.g., openclaw → openclaw-<owner>.<apps-domain>)"


# ---------------------------------------------------------------------------
# Job Types
# ---------------------------------------------------------------------------

job_types:

  #
  # openclaw-broker
  #
  - name: openclaw-broker
    resource_label: OpenClaw Service Broker
    resource_definitions:
      - name: ram
        type: integer
        configurable: false
        default: 1024
      - name: ephemeral_disk
        type: integer
        configurable: false
        default: 4096
      - name: persistent_disk
        type: integer
        configurable: false
        default: 0
      - name: cpu
        type: integer
        configurable: false
        default: 1
    static_ip: 0
    dynamic_ip: 1
    max_in_flight: 1
    single_az_only: true
    instance_definition:
      name: instances
      type: integer
      configurable: false
      default: 1
    manifest: |
      openclaw:
        broker:
          port: 8080
          auth:
            username: (( .properties.generated_broker_credentials.identity ))
            password: (( .properties.generated_broker_credentials.password ))
          bosh:
            director_url: https://(( $director.hostname )):25555
            uaa_url: https://(( $director.hostname )):8443
            client_id: (( $self.uaa_client_name ))
            client_secret: (( $self.uaa_client_secret ))
            ca_cert: (( $director.ca_public_key ))
          genai: (( .properties.genai_provider.selected_option.parsed_manifest(genai_fragment) ))
          security:
            sandbox_mode: (( .properties.sandbox_mode.value ))
            control_ui_enabled: (( .properties.control_ui_enabled.value ))
            blocked_commands: (( .properties.blocked_commands.value ))
            min_openclaw_version: (( .properties.min_openclaw_version.value ))
            sso_enabled: (( .properties.sso_enabled.value ))
            sso_client_id: (( .properties.sso_client_id.value ))
            sso_client_secret: (( .properties.sso_client_secret.value ))
            sso_cookie_secret: (( .properties.generated_sso_cookie_secret.password ))
            sso_oidc_issuer_url: https://uaa.(( ..cf.cloud_controller.system_domain.value ))
          on_demand:
            service_name: openclaw
            stemcell_os: ubuntu-jammy
            stemcell_version: latest
            network: (( $self.service_network ))
            az: (( .properties.on_demand_az.value ))
            openclaw_release_version: VERSION_PLACEHOLDER
            bpm_release_version: "1.1.21"
            routing_release_version: "0.283.0"
            plans:
              developer:
                enabled: (( .properties.developer_plan_enabled.value ))
                description: (( .properties.developer_plan_description.value ))
                vm_type: (( .properties.developer_plan_vm_type.value ))
                disk_type: (( .properties.developer_plan_disk_type.value ))
                browser_automation: (( .properties.developer_plan_browser_automation.value ))
                max_sessions: (( .properties.developer_plan_max_sessions.value ))
              developer_plus:
                enabled: (( .properties.developer_plus_plan_enabled.value ))
                description: (( .properties.developer_plus_plan_description.value ))
                vm_type: (( .properties.developer_plus_plan_vm_type.value ))
                disk_type: (( .properties.developer_plus_plan_disk_type.value ))
                browser_automation: (( .properties.developer_plus_plan_browser_automation.value ))
                max_sessions: (( .properties.developer_plus_plan_max_sessions.value ))
              team:
                enabled: (( .properties.team_plan_enabled.value ))
                description: (( .properties.team_plan_description.value ))
                vm_type: (( .properties.team_plan_vm_type.value ))
                disk_type: (( .properties.team_plan_disk_type.value ))
                browser_automation: (( .properties.team_plan_browser_automation.value ))
                max_sessions: (( .properties.team_plan_max_sessions.value ))
          cf:
            system_domain: (( ..cf.cloud_controller.system_domain.value ))
            apps_domain: (( ..cf.cloud_controller.apps_domain.value ))
            deployment_name: (( ..cf.deployment_name ))
          nats:
            tls:
              enabled: true
              client_cert: (( ..cf.properties.nats_client_cert.cert_pem ))
              client_key: (( ..cf.properties.nats_client_cert.private_key_pem ))
              ca_cert: (( ..cf.properties.nats_tls_external_cert.cert_pem ))
          limits:
            max_instances: (( .properties.max_instances.value ))
            max_instances_per_org: (( .properties.max_instances_per_org.value ))
      nats:
        tls:
          enabled: true
          client_cert: (( ..cf.properties.nats_client_cert.cert_pem ))
          client_key: (( ..cf.properties.nats_client_cert.private_key_pem ))
          ca_cert: (( ..cf.properties.nats_tls_external_cert.cert_pem ))
      route_registrar:
        routes:
          - name: openclaw-broker
            port: 8080
            registration_interval: 20s
            uris:
              - (( .properties.broker_route_prefix.value )).(( $runtime.apps_domains.[0] ))
    templates:
      - name: openclaw-broker
        release: openclaw
      - name: bpm
        release: bpm
      - name: route_registrar
        release: routing
        consumes: |
          nats-tls:
            from: nats-tls
            deployment: (( ..cf.deployment_name ))

  #
  # openclaw-registry
  #
  - name: openclaw-registry
    resource_label: OpenClaw Skills Registry
    resource_definitions:
      - name: ram
        type: integer
        configurable: false
        default: 1024
      - name: ephemeral_disk
        type: integer
        configurable: false
        default: 4096
      - name: persistent_disk
        type: integer
        configurable: true
        default: 10240
        constraints:
          min: 5120
      - name: cpu
        type: integer
        configurable: false
        default: 1
    static_ip: 0
    dynamic_ip: 1
    max_in_flight: 1
    single_az_only: true
    instance_definition:
      name: instances
      type: integer
      configurable: false
      default: 1
    manifest: |
      openclaw:
        registry:
          port: 8081
          skills_mode: (( .properties.skills_mode.value ))
          skills_allowlist: (( .properties.approved_skills.value ))
          auto_sync: (( .properties.auto_sync_from_clawhub.value ))
          scan_on_sync: (( .properties.scan_skills_on_sync.value ))
    templates:
      - name: openclaw-registry
        release: openclaw
      - name: bpm
        release: bpm

  #
  # openclaw-admin-dashboard
  #
  - name: openclaw-admin-dashboard
    resource_label: OpenClaw Admin Dashboard
    resource_definitions:
      - name: ram
        type: integer
        configurable: false
        default: 1024
      - name: ephemeral_disk
        type: integer
        configurable: false
        default: 4096
      - name: persistent_disk
        type: integer
        configurable: false
        default: 0
      - name: cpu
        type: integer
        configurable: false
        default: 1
    static_ip: 0
    dynamic_ip: 1
    max_in_flight: 1
    single_az_only: true
    instance_definition:
      name: instances
      type: integer
      configurable: false
      default: 1
    manifest: |
      openclaw:
        admin_dashboard:
          port: 8083
          broker_endpoint: http://(( ..openclaw-broker.first_ip )):8080
          auth:
            username: admin
            password: (( .properties.generated_broker_credentials.password ))
          route:
            hostname: (( .properties.dashboard_route_prefix.value ))
            domain: (( $runtime.apps_domains.[0] ))
      nats:
        tls:
          enabled: true
          client_cert: (( ..cf.properties.nats_client_cert.cert_pem ))
          client_key: (( ..cf.properties.nats_client_cert.private_key_pem ))
          ca_cert: (( ..cf.properties.nats_tls_external_cert.cert_pem ))
      route_registrar:
        routes:
          - name: openclaw-admin-dashboard
            port: 8083
            registration_interval: 20s
            uris:
              - (( .properties.dashboard_route_prefix.value )).(( $runtime.apps_domains.[0] ))
    templates:
      - name: openclaw-admin-dashboard
        release: openclaw
      - name: bpm
        release: bpm
      - name: route_registrar
        release: routing
        consumes: |
          nats-tls:
            from: nats-tls
            deployment: (( ..cf.deployment_name ))

  #
  # register-broker errand
  #
  - name: register-broker
    resource_label: Register Service Broker
    errand: true
    resource_definitions:
      - name: ram
        type: integer
        configurable: false
        default: 1024
      - name: ephemeral_disk
        type: integer
        configurable: false
        default: 2048
      - name: persistent_disk
        type: integer
        configurable: false
        default: 0
      - name: cpu
        type: integer
        configurable: false
        default: 1
    static_ip: 0
    dynamic_ip: 1
    max_in_flight: 1
    single_az_only: true
    instance_definition:
      name: instances
      type: integer
      configurable: false
      default: 1
    manifest: |
      cf:
        api_url: https://api.(( $runtime.system_domain ))
        admin_username: (( ..cf.uaa.system_services_credentials.identity ))
        admin_password: (( ..cf.uaa.system_services_credentials.password ))
        skip_ssl_validation: true
      broker:
        name: openclaw
        url: https://(( .properties.broker_route_prefix.value )).(( $runtime.apps_domains.[0] ))
        auth:
          username: (( .properties.generated_broker_credentials.identity ))
          password: (( .properties.generated_broker_credentials.password ))
        enable_service_access: true
    templates:
      - name: register-broker
        release: openclaw

  #
  # deregister-broker errand
  #
  - name: deregister-broker
    resource_label: Deregister Service Broker
    errand: true
    resource_definitions:
      - name: ram
        type: integer
        configurable: false
        default: 1024
      - name: ephemeral_disk
        type: integer
        configurable: false
        default: 2048
      - name: persistent_disk
        type: integer
        configurable: false
        default: 0
      - name: cpu
        type: integer
        configurable: false
        default: 1
    static_ip: 0
    dynamic_ip: 1
    max_in_flight: 1
    single_az_only: true
    instance_definition:
      name: instances
      type: integer
      configurable: false
      default: 1
    manifest: |
      cf:
        api_url: https://api.(( $runtime.system_domain ))
        admin_username: (( ..cf.uaa.system_services_credentials.identity ))
        admin_password: (( ..cf.uaa.system_services_credentials.password ))
        skip_ssl_validation: true
      broker:
        name: openclaw
    templates:
      - name: deregister-broker
        release: openclaw

  #
  # smoke-tests errand
  #
  - name: smoke-tests
    resource_label: Smoke Tests
    errand: true
    resource_definitions:
      - name: ram
        type: integer
        configurable: false
        default: 1024
      - name: ephemeral_disk
        type: integer
        configurable: false
        default: 2048
      - name: persistent_disk
        type: integer
        configurable: false
        default: 0
      - name: cpu
        type: integer
        configurable: false
        default: 1
    static_ip: 0
    dynamic_ip: 1
    max_in_flight: 1
    single_az_only: true
    instance_definition:
      name: instances
      type: integer
      configurable: false
      default: 1
    manifest: |
      cf:
        api_url: https://api.(( $runtime.system_domain ))
        admin_username: (( ..cf.uaa.system_services_credentials.identity ))
        admin_password: (( ..cf.uaa.system_services_credentials.password ))
        skip_ssl_validation: true
      smoke_tests:
        plan: ""
        timeout_seconds: 300
        verify_webchat_route: true
        test_prompt: "What is 2 + 2? Reply with just the number."
    templates:
      - name: smoke-tests
        release: openclaw

  #
  # upgrade-agents errand
  #
  - name: upgrade-agents
    resource_label: Upgrade Agent Instances
    errand: true
    resource_definitions:
      - name: ram
        type: integer
        configurable: false
        default: 1024
      - name: ephemeral_disk
        type: integer
        configurable: false
        default: 2048
      - name: persistent_disk
        type: integer
        configurable: false
        default: 0
      - name: cpu
        type: integer
        configurable: false
        default: 1
    static_ip: 0
    dynamic_ip: 1
    max_in_flight: 1
    single_az_only: true
    instance_definition:
      name: instances
      type: integer
      configurable: false
      default: 1
    manifest: |
      upgrade_agents:
        target_version: VERSION_PLACEHOLDER
        canary_percentage: 10
        pause_after_canary: true
        max_parallel: 5
        broker_endpoint: http://(( ..openclaw-broker.first_ip )):8080
        broker_auth:
          username: (( .properties.generated_broker_credentials.identity ))
          password: (( .properties.generated_broker_credentials.password ))
        health_check_timeout: 120
    templates:
      - name: upgrade-agents
        release: openclaw

# ---------------------------------------------------------------------------
# Post-Deploy Errands
# ---------------------------------------------------------------------------

post_deploy_errands:
  - name: register-broker
  - name: smoke-tests

# ---------------------------------------------------------------------------
# Pre-Delete Errands
# ---------------------------------------------------------------------------

pre_delete_errands:
  - name: deregister-broker
