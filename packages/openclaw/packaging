set -e
export PATH=/var/vcap/packages/node22/bin:$PATH
export HOME=/var/vcap

mkdir -p ${BOSH_INSTALL_TARGET}/lib
tar xzf ${BOSH_COMPILE_TARGET}/openclaw/openclaw-*.tgz \
  -C ${BOSH_INSTALL_TARGET}/lib/

mkdir -p ${BOSH_INSTALL_TARGET}/lib/skills
tar xzf ${BOSH_COMPILE_TARGET}/openclaw/skills-bundle-*.tgz \
  -C ${BOSH_INSTALL_TARGET}/lib/skills/

# Resolve the CLI entry point: prefer dist/entry.js (direct), fall back to bin field
PKG_DIR=${BOSH_INSTALL_TARGET}/lib/node_modules/openclaw
if [ -f "${PKG_DIR}/dist/entry.js" ]; then
  ENTRY="dist/entry.js"
  echo "Using direct entry point: ${ENTRY}"
else
  ENTRY=$(cd ${BOSH_INSTALL_TARGET}/lib && node -e "
    const p = require('./node_modules/openclaw/package.json');
    const bin = typeof p.bin === 'string' ? p.bin : (p.bin.openclaw || p.bin[Object.keys(p.bin)[0]]);
    console.log(bin);
  ")
  echo "Using bin entry point: ${ENTRY}"
fi

mkdir -p ${BOSH_INSTALL_TARGET}/bin
cat > ${BOSH_INSTALL_TARGET}/bin/openclaw <<WRAPPER
#!/bin/bash
export PATH=/var/vcap/packages/node22/bin:\$PATH
# cd into physical package dir to avoid Node.js symlink resolution issues
PKG_DIR="\$(cd "\$(dirname "\$0")/../lib/node_modules/openclaw" && pwd -P)"
cd "\${PKG_DIR}"
exec node ./${ENTRY} "\$@"
WRAPPER
chmod +x ${BOSH_INSTALL_TARGET}/bin/openclaw
