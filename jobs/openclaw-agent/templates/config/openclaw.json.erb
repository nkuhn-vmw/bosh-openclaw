<%
  # Port logic: SSO uses oauth2-proxy on 8080 → OpenClaw on 8081
  # Without SSO, OpenClaw listens directly on 8080
  sso_enabled = p('openclaw.sso.enabled')
  listen_port = sso_enabled ? 8081 : 8080

  # Auth mode: SSO → trusted-proxy (oauth2-proxy handles auth), otherwise token
  if sso_enabled
    auth = {
      "mode" => "trusted-proxy",
      "trustedProxies" => ["127.0.0.1"]
    }
  else
    auth = {
      "mode" => "token",
      "token" => p('openclaw.gateway.token')
    }
  end

  # Build models.providers based on configured LLM provider
  providers = {}

  provider = p('openclaw.llm.provider')

  if provider == 'genai'
    genai_endpoint = p('openclaw.llm.genai.endpoint', nil)
    genai_key = p('openclaw.llm.genai.api_key', nil)
    genai_model = p('openclaw.llm.genai.model')
    if genai_endpoint || genai_key
      prov = { "api" => "openai-completions" }
      prov["baseUrl"] = genai_endpoint if genai_endpoint
      prov["apiKey"] = genai_key if genai_key
      prov["models"] = [genai_model] if genai_model && genai_model != "auto"
      providers["genai"] = prov
    end
  end

  anthropic_key = p('openclaw.llm.anthropic.api_key', nil)
  if anthropic_key
    providers["anthropic"] = {
      "baseUrl" => "https://api.anthropic.com",
      "apiKey" => anthropic_key,
      "api" => "anthropic-messages"
    }
  end

  openai_key = p('openclaw.llm.openai.api_key', nil)
  if openai_key
    providers["openai"] = {
      "baseUrl" => "https://api.openai.com",
      "apiKey" => openai_key,
      "api" => "openai-completions"
    }
  end

  model_override = p('openclaw.llm.model_override', nil)

  config = {
    "gateway" => {
      "bind" => p('openclaw.gateway.bind_address'),
      "port" => listen_port,
      "auth" => auth
    },
    "models" => {
      "providers" => providers
    },
    "browser" => {
      "enabled" => p('openclaw.browser.enabled')
    },
    "logging" => {
      "level" => p('openclaw.logging.level')
    }
  }

  config["models"]["default"] = model_override if model_override
%>
<%= JSON.pretty_generate(config) %>
