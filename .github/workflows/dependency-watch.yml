name: Dependency Watch

on:
  schedule:
    - cron: '0 8 * * 1'  # Monday 8am UTC
  workflow_dispatch:

jobs:
  check-versions:
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
      - uses: actions/checkout@v4

      - name: Check dependency versions
        id: check
        run: |
          set -euo pipefail

          # --- Parse current versions from ci.yml ---
          CI_FILE=".github/workflows/ci.yml"

          CURRENT_NODE=$(grep -oP 'NODE_VERSION="\K[^"]+' "$CI_FILE" || echo "unknown")
          CURRENT_GO=$(grep -oP "go-version: '\K[^']+" "$CI_FILE" || echo "unknown")
          CURRENT_OAUTH2=$(grep -oP 'OAUTH2_PROXY_VERSION="\K[^"]+' "$CI_FILE" || echo "unknown")
          CURRENT_BPM=$(grep -oP 'BPM_VERSION="\K[^"]+' "$CI_FILE" || echo "unknown")
          CURRENT_ROUTING=$(grep -oP 'ROUTING_VERSION="\K[^"]+' "$CI_FILE" || echo "unknown")

          echo "Current versions:"
          echo "  Node.js: $CURRENT_NODE"
          echo "  Go: $CURRENT_GO"
          echo "  oauth2-proxy: $CURRENT_OAUTH2"
          echo "  BPM: $CURRENT_BPM"
          echo "  Routing: $CURRENT_ROUTING"

          # --- Fetch latest versions ---

          # Node.js 22.x LTS
          LATEST_NODE=$(curl -sf "https://nodejs.org/dist/index.json" | \
            python3 -c "import sys,json; versions=json.load(sys.stdin); lts=[v for v in versions if v.get('lts') and v['version'].startswith('v22.')]; print(lts[0]['version'].lstrip('v') if lts else 'unknown')")

          # Go 1.22.x
          LATEST_GO=$(curl -sf "https://go.dev/dl/?mode=json" | \
            python3 -c "import sys,json; versions=json.load(sys.stdin); matches=[v['version'].replace('go','') for v in versions if v['version'].startswith('go1.22.')]; print(matches[0] if matches else 'unknown')")

          # oauth2-proxy
          LATEST_OAUTH2=$(curl -sf "https://api.github.com/repos/oauth2-proxy/oauth2-proxy/releases/latest" | \
            python3 -c "import sys,json; print(json.load(sys.stdin)['tag_name'].lstrip('v'))")

          # BPM release
          LATEST_BPM=$(curl -sf "https://api.github.com/repos/cloudfoundry/bpm-release/releases/latest" | \
            python3 -c "import sys,json; print(json.load(sys.stdin)['tag_name'].lstrip('v'))")

          # Routing release
          LATEST_ROUTING=$(curl -sf "https://api.github.com/repos/cloudfoundry/routing-release/releases/latest" | \
            python3 -c "import sys,json; print(json.load(sys.stdin)['tag_name'].lstrip('v'))")

          echo ""
          echo "Latest versions:"
          echo "  Node.js: $LATEST_NODE"
          echo "  Go: $LATEST_GO"
          echo "  oauth2-proxy: $LATEST_OAUTH2"
          echo "  BPM: $LATEST_BPM"
          echo "  Routing: $LATEST_ROUTING"

          # --- Build update table ---
          UPDATES=""
          if [ "$CURRENT_NODE" != "$LATEST_NODE" ]; then
            UPDATES="${UPDATES}| Node.js 22.x LTS | $CURRENT_NODE | $LATEST_NODE |\n"
          fi
          if [ "$CURRENT_GO" != "$LATEST_GO" ]; then
            UPDATES="${UPDATES}| Go | $CURRENT_GO | $LATEST_GO |\n"
          fi
          if [ "$CURRENT_OAUTH2" != "$LATEST_OAUTH2" ]; then
            UPDATES="${UPDATES}| oauth2-proxy | $CURRENT_OAUTH2 | $LATEST_OAUTH2 |\n"
          fi
          if [ "$CURRENT_BPM" != "$LATEST_BPM" ]; then
            UPDATES="${UPDATES}| BPM release | $CURRENT_BPM | $LATEST_BPM |\n"
          fi
          if [ "$CURRENT_ROUTING" != "$LATEST_ROUTING" ]; then
            UPDATES="${UPDATES}| Routing release | $CURRENT_ROUTING | $LATEST_ROUTING |\n"
          fi

          if [ -z "$UPDATES" ]; then
            echo "All dependencies are up to date!"
            echo "has_updates=false" >> "$GITHUB_OUTPUT"
          else
            echo "Updates available."
            echo "has_updates=true" >> "$GITHUB_OUTPUT"

            # Write body to file (multi-line output)
            {
              echo "## Dependency Update Report"
              echo ""
              echo "The following vendored dependencies have newer versions available:"
              echo ""
              echo "| Dependency | Current | Latest |"
              echo "|---|---|---|"
              echo -e "$UPDATES"
              echo ""
              echo "### Files to update"
              echo "- \`.github/workflows/ci.yml\` â€” version constants"
              echo ""
              echo "*Generated by dependency-watch workflow on $(date -u +%Y-%m-%d)*"
            } > /tmp/issue-body.md
          fi

      - name: Create or update issue
        if: steps.check.outputs.has_updates == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          LABEL="dependencies"

          # Ensure label exists
          gh label create "$LABEL" --description "Dependency version updates" --color "0075ca" 2>/dev/null || true

          # Check for existing open issue with this label
          EXISTING=$(gh issue list --label "$LABEL" --state open --json number --jq '.[0].number // empty')

          if [ -n "$EXISTING" ]; then
            echo "Adding comment to existing issue #$EXISTING"
            gh issue comment "$EXISTING" --body-file /tmp/issue-body.md
          else
            echo "Creating new issue"
            gh issue create \
              --title "Dependency updates available" \
              --body-file /tmp/issue-body.md \
              --label "$LABEL"
          fi
