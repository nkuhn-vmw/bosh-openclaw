## OAuth2 Proxy Configuration
## Generated by BOSH - do not edit manually

http_address = "0.0.0.0:<%= p('openclaw.sso_proxy.listen_port') %>"
upstreams = [
  "http://127.0.0.1:<%= p('openclaw.sso_proxy.upstream_port') %>"
]

provider = "<%= p('openclaw.sso_proxy.provider') %>"
client_id = "<%= p('openclaw.sso_proxy.client_id') %>"
client_secret = "<%= p('openclaw.sso_proxy.client_secret') %>"

cookie_secret = "<%= p('openclaw.sso_proxy.cookie_secret') %>"
cookie_name = "<%= p('openclaw.sso_proxy.cookie_name') %>"
cookie_secure = true
cookie_httponly = true
cookie_expire = "<%= p('openclaw.sso_proxy.session_timeout') %>"

<% if_p('openclaw.sso_proxy.oidc_issuer_url') do |issuer| %>
oidc_issuer_url = "<%= issuer %>"
<% end %>

# CF UAA has a split architecture: login.sys.* serves OIDC discovery but
# reports uaa.sys.* as the issuer. Skip strict issuer verification.
insecure_oidc_skip_issuer_verification = true

# CF UAA p-identity may not support the default 'email' scope
scope = "openid"

<% redirect_url = p('openclaw.sso_proxy.redirect_url', '') %>
<% unless redirect_url.empty? %>
redirect_url = "<%= redirect_url %>"
<% end %>

<% domains = p('openclaw.sso_proxy.allowed_domains') %>
<% unless domains.empty? %>
email_domains = [
<% domains.each_with_index do |domain, index| %>
  "<%= domain %>"<%= index < domains.length - 1 ? ',' : '' %>
<% end %>
]
<% else %>
email_domains = ["*"]
<% end %>

<% emails = p('openclaw.sso_proxy.allowed_emails') %>
<% unless emails.empty? %>
authenticated_emails_file = "/var/vcap/jobs/openclaw-sso-proxy/config/allowed-emails.txt"
<% end %>

reverse_proxy = true
proxy_websockets = true
pass_access_token = true
pass_authorization_header = true
skip_provider_button = true
