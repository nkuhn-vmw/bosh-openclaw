#!/bin/bash

set -eu
export PATH="/var/vcap/packages/cf-cli/bin:${PATH}"

CF_API="<%= p('cf.api_url') %>"
CF_USER="<%= p('cf.admin_username') %>"
CF_PASSWORD="<%= p('cf.admin_password') %>"

SSL_FLAG=""
<% if p('cf.skip_ssl_validation') %>
SSL_FLAG="--skip-ssl-validation"
<% end %>

echo "=== OpenClaw Smoke Tests ==="
echo ""

# Login
echo "[1/3] Logging in to Cloud Foundry..."
cf api "${CF_API}" ${SSL_FLAG}
cf auth "${CF_USER}" "${CF_PASSWORD}"

# Verify service is available in marketplace
echo "[2/3] Verifying openclaw service in marketplace..."
cf create-org openclaw-smoke-tests 2>/dev/null || true
cf target -o openclaw-smoke-tests
cf create-space smoke-tests 2>/dev/null || true
cf target -s smoke-tests

if ! cf marketplace | grep -q "openclaw"; then
  echo "FAIL: openclaw service not found in marketplace"
  cf delete-org openclaw-smoke-tests -f 2>/dev/null || true
  exit 1
fi
echo "PASS: openclaw service found in marketplace"

# Verify broker catalog has plans
echo "[3/3] Verifying service plans..."
PLAN_COUNT=$(cf marketplace -e openclaw 2>/dev/null | grep -c "openclaw-" || echo "0")
if [ "${PLAN_COUNT}" -gt 0 ]; then
  echo "PASS: Found ${PLAN_COUNT} service plan(s)"
else
  echo "WARN: No plans found (operators should configure plans in OpsMan)"
fi

# Cleanup
cf delete-org openclaw-smoke-tests -f 2>/dev/null || true

echo ""
echo "=== All smoke tests passed ==="
