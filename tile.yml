---
name: openclaw
icon_file: resources/icon.png
label: OpenClaw AI Agent Platform
metadata_version: 3.0
description: |
  Deploy dedicated OpenClaw AI agents for developers and teams.
  Each agent runs on an isolated VM with its own WebChat UI,
  enterprise security controls, centralized LLM integration,
  and curated skills management.

service_broker: true

requires_product_versions:
  - name: cf
    version: "~> 4.0"

stemcell_criteria:
  os: ubuntu-jammy
  version: '1.0'

# ---------------------------------------------------------------------------
# On-Demand Service Plans (dynamic — operators add/remove plans in OpsMan)
# ---------------------------------------------------------------------------

service_plan_forms:
  - name: on_demand_agent_plans
    label: On-Demand Agent Plans
    description: |
      Configure agent plans available in the CF marketplace.
      Each plan defines the VM size, disk, and capabilities for agent instances.
      Operators can add multiple plans — developers choose a plan when creating
      a service instance via `cf create-service openclaw <plan-name>`.
    optional: true
    properties:
      - name: plan_description
        type: string
        label: Plan Description
        description: Description shown to developers in the marketplace
        configurable: true
        default: "OpenClaw AI agent instance"
      - name: vm_type
        type: vm_type_dropdown
        label: VM Type
        description: VM size for agent instances. Larger VMs provide more CPU and memory for AI workloads.
        configurable: true
      - name: disk_type
        type: disk_type_dropdown
        label: Persistent Disk Type
        description: Persistent disk for agent workspace and project files.
        configurable: true
      - name: browser_automation
        type: boolean
        label: Enable Browser Automation
        description: Allow agents on this plan to use browser automation tools (Puppeteer, Playwright)
        default: false
        configurable: true
      - name: max_sessions
        type: integer
        label: Max Concurrent Sessions
        description: Maximum number of concurrent chat sessions per agent instance
        default: 1
        configurable: true
        constraints:
          min: 1
          max: 10
      - name: az
        type: string
        label: Availability Zone(s)
        description: "Comma-separated BOSH AZ names for this plan (e.g. az1 or az1,az2)"
        configurable: true
        default: "az1"
      - name: instance_quota
        type: integer
        label: Instance Quota
        description: Maximum number of service instances allowed for this plan (across all orgs)
        default: 10
        configurable: true
        constraints:
          min: 1
          max: 1000

# ---------------------------------------------------------------------------
# Packages (BOSH releases)
# ---------------------------------------------------------------------------

packages:
  - name: openclaw
    type: bosh-release
    path: resources/openclaw-release.tgz
    jobs:

      # --- Service Broker ---------------------------------------------------
      - name: openclaw-broker
        label: OpenClaw Service Broker
        templates:
          - name: openclaw-broker
            release: openclaw
          - name: route_registrar
            release: routing
            consumes:
              nats-tls:
                from: nats-tls
                deployment: (( ..cf.deployment_name ))
          - name: bpm
            release: bpm
        memory: 1024
        ephemeral_disk: 4096
        instances: 1
        cpu: 1
        static_ip: 0
        dynamic_ip: 1
        max_in_flight: 1
        properties:
          nats:
            tls:
              enabled: true
              client_cert: (( ..cf.properties.nats_client_cert.cert_pem ))
              client_key: (( ..cf.properties.nats_client_cert.private_key_pem ))
              ca_cert: (( ..cf.properties.nats_tls_external_cert.cert_pem ))
          route_registrar:
            routes:
              - name: openclaw-broker
                port: 8080
                registration_interval: 20s
                uris:
                  - (( .properties.broker_route_prefix.value )).(( ..cf.cloud_controller.system_domain.value ))
          openclaw:
            broker:
              port: 8080
              auth:
                username: (( .properties.generated_broker_credentials.identity ))
                password: (( .properties.generated_broker_credentials.password ))
              bosh:
                director_url: https://(( $director.hostname )):25555
                ca_cert: (( $director.ca_public_key ))
                uaa_url: https://(( $director.hostname )):8443
                client_id: (( $self.uaa_client_name ))
                client_secret: (( $self.uaa_client_secret ))
              genai: (( .properties.genai_provider.selected_option.parsed_manifest(genai_fragment) ))
              security:
                sandbox_mode: (( .properties.sandbox_mode.value ))
                control_ui_enabled: (( .properties.control_ui_enabled.value ))
                blocked_commands: (( .properties.blocked_commands.value ))
                min_openclaw_version: (( .properties.min_openclaw_version.value ))
              on_demand:
                service_name: openclaw
                plans: (( .properties.on_demand_agent_plans.value ))
                stemcell_os: ubuntu-jammy
                stemcell_version: latest
                network: (( $self.service_network ))
                az: (( .properties.on_demand_az.value ))
              cf:
                system_domain: (( ..cf.cloud_controller.system_domain.value ))
                apps_domain: (( ..cf.cloud_controller.apps_domain.value ))
                deployment_name: (( ..cf.deployment_name ))
              nats:
                tls:
                  enabled: true
                  client_cert: (( ..cf.properties.nats_client_cert.cert_pem ))
                  client_key: (( ..cf.properties.nats_client_cert.private_key_pem ))
                  ca_cert: (( ..cf.properties.nats_tls_external_cert.cert_pem ))

      # --- Skills Registry --------------------------------------------------
      - name: openclaw-registry
        label: OpenClaw Skills Registry
        templates:
          - name: openclaw-registry
            release: openclaw
          - name: bpm
            release: bpm
        memory: 1024
        ephemeral_disk: 4096
        persistent_disk: 10240
        instances: 1
        cpu: 1
        static_ip: 0
        dynamic_ip: 1
        max_in_flight: 1
        properties:
          openclaw:
            registry:
              port: 8081
              skills_mode: (( .properties.skills_mode.value ))
              skills_allowlist: (( .properties.approved_skills.value ))
              auto_sync: (( .properties.auto_sync_from_clawhub.value ))
              scan_on_sync: (( .properties.scan_skills_on_sync.value ))

      # --- Admin Dashboard ---------------------------------------------------
      - name: openclaw-admin-dashboard
        label: OpenClaw Admin Dashboard
        templates:
          - name: openclaw-admin-dashboard
            release: openclaw
          - name: route_registrar
            release: routing
            consumes:
              nats-tls:
                from: nats-tls
                deployment: (( ..cf.deployment_name ))
          - name: bpm
            release: bpm
        memory: 1024
        ephemeral_disk: 4096
        instances: 1
        cpu: 1
        static_ip: 0
        dynamic_ip: 1
        max_in_flight: 1
        properties:
          nats:
            tls:
              enabled: true
              client_cert: (( ..cf.properties.nats_client_cert.cert_pem ))
              client_key: (( ..cf.properties.nats_client_cert.private_key_pem ))
              ca_cert: (( ..cf.properties.nats_tls_external_cert.cert_pem ))
          route_registrar:
            routes:
              - name: openclaw-admin-dashboard
                port: 8083
                registration_interval: 20s
                uris:
                  - (( .properties.dashboard_route_prefix.value )).(( ..cf.cloud_controller.system_domain.value ))
          openclaw:
            admin_dashboard:
              port: 8083
              broker_endpoint: https://(( .properties.broker_route_prefix.value )).(( ..cf.cloud_controller.system_domain.value ))
              auth:
                username: admin
                password: (( .properties.generated_broker_credentials.password ))
              route:
                hostname: (( .properties.dashboard_route_prefix.value ))
                domain: (( ..cf.cloud_controller.system_domain.value ))

      # --- Register Broker Errand -------------------------------------------
      - name: register-broker
        label: Register Service Broker
        templates:
          - name: register-broker
            release: openclaw
        lifecycle: errand
        post_deploy: true
        memory: 1024
        ephemeral_disk: 2048
        instances: 1
        cpu: 1
        static_ip: 0
        dynamic_ip: 1
        properties:
          cf:
            api_url: https://api.(( ..cf.cloud_controller.system_domain.value ))
            admin_username: (( ..cf.uaa.system_services_credentials.identity ))
            admin_password: (( ..cf.uaa.system_services_credentials.password ))
            skip_ssl_validation: true
          broker:
            name: openclaw
            url: https://(( .properties.broker_route_prefix.value )).(( ..cf.cloud_controller.system_domain.value ))
            auth:
              username: (( .properties.generated_broker_credentials.identity ))
              password: (( .properties.generated_broker_credentials.password ))
            enable_service_access: true

      # --- Deregister Broker Errand -----------------------------------------
      - name: deregister-broker
        label: Deregister Service Broker
        templates:
          - name: deregister-broker
            release: openclaw
        lifecycle: errand
        pre_delete: true
        memory: 1024
        ephemeral_disk: 2048
        instances: 1
        cpu: 1
        static_ip: 0
        dynamic_ip: 1
        properties:
          cf:
            api_url: https://api.(( ..cf.cloud_controller.system_domain.value ))
            admin_username: (( ..cf.uaa.system_services_credentials.identity ))
            admin_password: (( ..cf.uaa.system_services_credentials.password ))
            skip_ssl_validation: true
          broker:
            name: openclaw

      # --- Smoke Tests Errand -----------------------------------------------
      - name: smoke-tests
        label: Smoke Tests
        templates:
          - name: smoke-tests
            release: openclaw
        lifecycle: errand
        post_deploy: true
        memory: 1024
        ephemeral_disk: 2048
        instances: 1
        cpu: 1
        static_ip: 0
        dynamic_ip: 1
        properties:
          cf:
            api_url: https://api.(( ..cf.cloud_controller.system_domain.value ))
            admin_username: (( ..cf.uaa.system_services_credentials.identity ))
            admin_password: (( ..cf.uaa.system_services_credentials.password ))
            skip_ssl_validation: true
          smoke_tests:
            plan: developer
            lifecycle_test: false
            timeout_seconds: 300
            verify_webchat_route: true
            test_prompt: "What is 2 + 2? Reply with just the number."

  - name: bpm
    type: bosh-release
    path: resources/bpm-release.tgz

  - name: routing
    type: bosh-release
    path: resources/routing-release.tgz

# ---------------------------------------------------------------------------
# Forms (operator configuration tabs in OpsMan)
# ---------------------------------------------------------------------------

forms:
  - name: genai-config
    label: GenAI / LLM Configuration
    description: Configure the LLM provider for all OpenClaw agents
    properties:
      - name: genai_provider
        type: selector
        label: LLM Provider
        configurable: true
        default: "Tanzu GenAI Service"
        option_templates:
          - name: tanzu_genai
            select_value: "Tanzu GenAI Service"
            named_manifests:
              - name: genai_fragment
                manifest: |
                  provider: tanzu_genai
                  offering_name: (( .properties.genai_provider.tanzu_genai.offering_name.value ))
                  plan_name: (( .properties.genai_provider.tanzu_genai.plan_name.value ))
            property_blueprints:
              - name: offering_name
                type: string
                label: GenAI Offering Name
                description: Name of the GenAI service offering in the marketplace
                configurable: true
              - name: plan_name
                type: string
                label: GenAI Plan Name
                description: Plan name for the GenAI service instance
                configurable: true
          - name: anthropic_direct
            select_value: "Anthropic (Direct)"
            named_manifests:
              - name: genai_fragment
                manifest: |
                  provider: anthropic
                  api_key: (( .properties.genai_provider.anthropic_direct.api_key.value ))
                  model: (( .properties.genai_provider.anthropic_direct.model.value ))
            property_blueprints:
              - name: api_key
                type: secret
                label: Anthropic API Key
                configurable: true
              - name: model
                type: dropdown_select
                label: Model
                configurable: true
                default: "claude-sonnet-4-5-20250929"
                options:
                  - name: "claude-opus-4-6"
                    label: "Claude Opus 4.6"
                  - name: "claude-sonnet-4-5-20250929"
                    label: "Claude Sonnet 4.5"
                  - name: "claude-haiku-4-5-20251001"
                    label: "Claude Haiku 4.5"
          - name: openai_direct
            select_value: "OpenAI (Direct)"
            named_manifests:
              - name: genai_fragment
                manifest: |
                  provider: openai
                  api_key: (( .properties.genai_provider.openai_direct.api_key.value ))
                  model: (( .properties.genai_provider.openai_direct.model.value ))
            property_blueprints:
              - name: api_key
                type: secret
                label: OpenAI API Key
                configurable: true
              - name: model
                type: string
                label: Model
                configurable: true
                default: "gpt-4o"
          - name: external_openai
            select_value: "External OpenAI API"
            named_manifests:
              - name: genai_fragment
                manifest: |
                  provider: external_openai
                  api_endpoint: (( .properties.genai_provider.external_openai.api_endpoint.value ))
                  api_key: (( .properties.genai_provider.external_openai.api_key.value ))
                  model: (( .properties.genai_provider.external_openai.model.value ))
            property_blueprints:
              - name: api_endpoint
                type: string
                label: API Endpoint URL
                description: Base URL of the OpenAI-compatible API
                configurable: true
              - name: api_key
                type: secret
                label: API Key
                configurable: true
              - name: model
                type: string
                label: Model
                configurable: true
                default: "gpt-4o"

  - name: security-config
    label: Security & Compliance
    description: Enterprise security controls for all agent instances
    properties:
      - name: sandbox_mode
        type: dropdown_select
        label: Sandbox Mode
        configurable: true
        default: "strict"
        options:
          - name: strict
            label: "Strict - All commands require explicit approval"
          - name: moderate
            label: "Moderate - Common commands allowed, destructive blocked"
          - name: loose
            label: "Loose - Most commands allowed (not recommended)"
      - name: control_ui_enabled
        type: boolean
        label: Enable Control UI
        configurable: true
        default: false
        description: >
          WARNING: The Control UI was the attack vector for CVE-2026-25253.
          Enable only on patched versions with auth required.
      - name: blocked_commands
        type: text
        label: Blocked Shell Commands
        configurable: true
        default: "rm -rf /\ndd if=/dev/zero\nmkfs\ncurl\nwget"
        description: One command per line
      - name: min_openclaw_version
        type: string
        label: Minimum OpenClaw Version
        configurable: true
        default: "2026.1.29"
        description: Refuse to deploy agents below this version

  - name: skills-config
    label: Skills Management
    description: Control which skills are available to agents
    properties:
      - name: skills_mode
        type: dropdown_select
        label: Skills Policy
        configurable: true
        default: "allowlist"
        options:
          - name: allowlist
            label: "Allowlist - Only approved skills"
          - name: blocklist
            label: "Blocklist - All except blocked"
          - name: disabled
            label: "Disabled - Built-in tools only"
      - name: approved_skills
        type: text
        label: Approved Skills
        configurable: true
        description: One skill name per line
        default: |
          weather
          calendar-google
          email-gmail
          github
          jira
          slack-actions
          notion
      - name: auto_sync_from_clawhub
        type: boolean
        label: Auto-sync from ClawHub
        configurable: true
        default: true
      - name: scan_skills_on_sync
        type: boolean
        label: Security Scan Skills on Sync
        configurable: true
        default: true

  - name: sso-config
    label: SSO / Authentication
    description: Configure Single Sign-On for agent WebChat instances
    properties:
      - name: sso_enabled
        type: boolean
        label: Enable SSO for Agent Instances
        configurable: true
        default: true
        description: Each agent WebChat UI is protected by SSO via p-identity
      - name: sso_plan
        type: string
        label: p-identity Service Plan
        configurable: true
        default: "uaa"
      - name: sso_allowed_email_domains
        type: text
        label: Allowed Email Domains
        configurable: true
        description: One per line (e.g., example.com). Empty = all authenticated users
        optional: true
      - name: sso_session_timeout_hours
        type: integer
        label: Session Timeout (hours)
        configurable: true
        default: 8

  - name: broker-config
    label: Service Broker
    description: Configure broker credentials and route prefixes
    properties:
      - name: on_demand_az
        type: service_network_az_multi_select
        label: Default Availability Zones for On-Demand Agents
        configurable: true
        description: Fallback AZs used when a plan does not specify its own
      - name: generated_broker_credentials
        type: simple_credentials
        label: Broker Credentials (Auto-generated)
        configurable: false
      - name: broker_route_prefix
        type: string
        label: Broker Route Prefix
        configurable: true
        default: "openclaw-broker"
        description: "Route prefix for broker (e.g., openclaw-broker → openclaw-broker.<system-domain>)"
      - name: dashboard_route_prefix
        type: string
        label: Dashboard Route Prefix
        configurable: true
        default: "openclaw-admin"
        description: "Route prefix for admin dashboard"
      - name: agent_route_prefix
        type: string
        label: Agent Route Prefix
        configurable: true
        default: "openclaw"
        description: "Route prefix for agent instances (e.g., openclaw → openclaw-<owner>.<apps-domain>)"
