<%
  # Use on-demand plans from OpsMan service_plan_forms if configured,
  # otherwise fall back to static catalog.plans defaults
  on_demand_plans = p("openclaw.broker.on_demand.plans")
  static_plans = p("openclaw.broker.catalog.plans")

  # Normalize on_demand_plans: tile manifest provides a Hash (plan_name => config),
  # while the Go broker produces an Array. Handle both formats.
  if on_demand_plans.is_a?(Hash)
    on_demand_plans = on_demand_plans.select { |_, cfg| cfg.fetch("enabled", true) }.map do |name, cfg|
      {
        "name" => name.to_s.tr('_', '-'),
        "description" => (cfg["plan_description"] || cfg["description"] || "").to_s,
        "vm_type" => cfg["vm_type"].to_s,
        "disk_type" => cfg["disk_type"].to_s,
        "browser_automation" => cfg.fetch("browser_automation", false),
        "max_sessions" => cfg.fetch("max_sessions", 1),
      }
    end
  end

  if on_demand_plans.is_a?(Array) && !on_demand_plans.empty?
    # Plans from OpsMan service_plan_forms
    catalog_plans = on_demand_plans.each_with_index.map do |plan, idx|
      plan_name = plan["name"] || "plan-#{idx}"
      {
        "id" => "openclaw-#{plan_name}-plan",
        "name" => plan_name,
        "description" => plan["description"] || plan["plan_description"] || "OpenClaw AI agent instance",
        "free" => false,
        "bindable" => true,
        "plan_updateable" => true,
        "metadata" => {
          "displayName" => plan_name.split(/[-_]/).map(&:capitalize).join(" "),
          "vm_type" => plan["vm_type"],
          "disk_type" => plan["disk_type"],
          "bullets" => [
            "Dedicated VM with isolated WebChat UI",
            "VM type: #{plan["vm_type"] || "default"}",
            "Disk type: #{plan["disk_type"] || "default"}",
            plan["browser_automation"] ? "Browser automation enabled" : nil,
            "Max #{plan["max_sessions"] || 1} concurrent session(s)",
            "Instance quota: #{plan["instance_quota"] || 10}"
          ].compact
        },
        "schemas" => {
          "service_instance" => {
            "create" => {
              "parameters" => {
                "$schema" => "http://json-schema.org/draft-04/schema#",
                "type" => "object",
                "properties" => {
                  "owner" => {
                    "type" => "string",
                    "description" => "Developer or team who owns this instance"
                  }
                }
              }
            }
          }
        }
      }
    end
  else
    # Static plans from spec defaults
    catalog_plans = static_plans.map do |plan|
      catalog_plan = {
        "id" => plan["id"],
        "name" => plan["name"],
        "description" => plan["description"],
        "free" => false,
        "bindable" => true,
        "plan_updateable" => true,
        "metadata" => {
          "displayName" => plan.dig("metadata", "displayName") || plan["name"],
          "bullets" => plan.dig("metadata", "bullets") || []
        },
        "schemas" => {
          "service_instance" => {
            "create" => {
              "parameters" => {
                "$schema" => "http://json-schema.org/draft-04/schema#",
                "type" => "object",
                "properties" => {
                  "owner" => {
                    "type" => "string",
                    "description" => "Developer or team who owns this instance"
                  }
                }
              }
            }
          }
        }
      }

      if plan["vm_type"]
        catalog_plan["metadata"]["vm_type"] = plan["vm_type"]
      end

      if plan["disk_type"]
        catalog_plan["metadata"]["disk_type"] = plan["disk_type"]
      end

      catalog_plan
    end
  end

  catalog = {
    "services" => [
      {
        "id" => "openclaw-service",
        "name" => "openclaw",
        "description" => "Dedicated AI coding agent powered by OpenClaw",
        "bindable" => true,
        "instances_retrievable" => true,
        "bindings_retrievable" => true,
        "plan_updateable" => true,
        "tags" => ["ai", "coding-agent", "developer-tools", "openclaw"],
        "metadata" => {
          "displayName" => "OpenClaw AI Agent",
          "longDescription" => "Provision dedicated OpenClaw AI coding agent instances with isolated VMs, WebChat UI, and configurable LLM backends.",
          "providerDisplayName" => "OpenClaw",
          "documentationUrl" => "https://docs.openclaw.dev/service-broker",
          "supportUrl" => "https://github.com/openclaw/bosh-openclaw/issues"
        },
        "plans" => catalog_plans
      }
    ]
  }
%><%= JSON.pretty_generate(catalog) %>
