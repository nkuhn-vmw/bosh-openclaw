#!/bin/bash

set -eu

export PATH="/var/vcap/packages/node22/bin:/var/vcap/packages/openclaw/bin:$PATH"
export HOME="/var/vcap/data/openclaw-registry"

JOB_NAME="openclaw-registry"
RUN_DIR="/var/vcap/sys/run/${JOB_NAME}"
LOG_DIR="/var/vcap/sys/log/${JOB_NAME}"
PIDFILE="${RUN_DIR}/${JOB_NAME}.pid"
STORAGE_DIR="<%= p('openclaw.registry.storage_dir') %>"

case $1 in
  start)
    mkdir -p "${RUN_DIR}" "${LOG_DIR}" "${HOME}" "${STORAGE_DIR}"
    chown -R vcap:vcap "${RUN_DIR}" "${LOG_DIR}" "${HOME}" "${STORAGE_DIR}"

    echo $$ > "${PIDFILE}"

    <% if p('openclaw.registry.auto_sync') %>
    # Run initial sync before starting
    /var/vcap/jobs/${JOB_NAME}/bin/sync \
      >> "${LOG_DIR}/sync.stdout.log" \
      2>> "${LOG_DIR}/sync.stderr.log" \
      || echo "WARNING: Initial sync failed, continuing with existing skills"
    <% end %>

    exec chpst -u vcap:vcap \
      openclaw registry serve \
        --port "<%= p('openclaw.registry.port') %>" \
        --storage-dir "${STORAGE_DIR}" \
        --allowlist /var/vcap/jobs/${JOB_NAME}/config/allowlist.yml \
      >> "${LOG_DIR}/${JOB_NAME}.stdout.log" \
      2>> "${LOG_DIR}/${JOB_NAME}.stderr.log"
    ;;

  stop)
    if [ -f "${PIDFILE}" ]; then
      PID=$(cat "${PIDFILE}")
      if kill -0 "${PID}" 2>/dev/null; then
        kill -TERM "${PID}"

        TIMEOUT=30
        while [ ${TIMEOUT} -gt 0 ] && kill -0 "${PID}" 2>/dev/null; do
          sleep 1
          TIMEOUT=$((TIMEOUT - 1))
        done

        if kill -0 "${PID}" 2>/dev/null; then
          kill -9 "${PID}"
        fi
      fi
      rm -f "${PIDFILE}"
    fi
    ;;

  *)
    echo "Usage: ctl {start|stop}"
    exit 1
    ;;
esac
