<%
  # Port logic: SSO uses oauth2-proxy on 8080 → OpenClaw on 8081
  # Without SSO, OpenClaw listens directly on 8080
  sso_enabled = p('openclaw.sso.enabled')
  listen_port = sso_enabled ? 8081 : 8080

  # Auth mode: SSO → trusted-proxy (oauth2-proxy handles auth), otherwise token
  if sso_enabled
    auth = {
      "mode" => "trusted-proxy",
      "trustedProxy" => {
        "userHeader" => "X-Forwarded-User"
      }
    }
  else
    auth = {
      "mode" => "token",
      "token" => p('openclaw.gateway.token')
    }
  end

  # Trusted proxies list (gateway-level, outside auth block)
  trusted_proxies = sso_enabled ? ["127.0.0.1"] : nil

  # Build models.providers based on configured LLM provider
  # Each provider requires baseUrl and models (array of {id, name} objects)
  providers = {}

  provider = p('openclaw.llm.provider')

  if provider == 'genai'
    genai_endpoint = p('openclaw.llm.genai.endpoint', nil)
    genai_key = p('openclaw.llm.genai.api_key', nil)
    genai_model = p('openclaw.llm.genai.model')
    if genai_endpoint || genai_key
      prov = { "api" => "openai-completions" }
      prov["baseUrl"] = genai_endpoint if genai_endpoint
      prov["apiKey"] = genai_key if genai_key
      if genai_model && genai_model != "auto"
        prov["models"] = [{ "id" => genai_model, "name" => genai_model }]
      else
        prov["models"] = [{ "id" => "default", "name" => "default" }]
      end
      providers["genai"] = prov
    end
  end

  anthropic_key = p('openclaw.llm.anthropic.api_key', nil)
  if anthropic_key
    providers["anthropic"] = {
      "baseUrl" => "https://api.anthropic.com",
      "apiKey" => anthropic_key,
      "api" => "anthropic-messages",
      "models" => [{ "id" => "claude-sonnet-4-5-20250929", "name" => "Claude Sonnet 4.5" }]
    }
  end

  openai_key = p('openclaw.llm.openai.api_key', nil)
  if openai_key
    providers["openai"] = {
      "baseUrl" => "https://api.openai.com",
      "apiKey" => openai_key,
      "api" => "openai-completions",
      "models" => [{ "id" => "gpt-4o", "name" => "GPT-4o" }]
    }
  end

  # gateway.bind must be an enum: "lan" binds to 0.0.0.0
  config = {
    "gateway" => {
      "bind" => "lan",
      "port" => listen_port,
      "auth" => auth
    },
    "models" => {
      "providers" => providers
    },
    "browser" => {
      "enabled" => p('openclaw.browser.enabled')
    },
    "logging" => {
      "level" => p('openclaw.logging.level')
    }
  }

  config["gateway"]["trustedProxies"] = trusted_proxies if trusted_proxies
%>
<%= JSON.pretty_generate(config) %>
