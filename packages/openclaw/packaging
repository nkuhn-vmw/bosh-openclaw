set -e
export PATH=/var/vcap/packages/node22/bin:$PATH
export HOME=/var/vcap

mkdir -p ${BOSH_INSTALL_TARGET}/lib
tar xzf ${BOSH_COMPILE_TARGET}/openclaw/openclaw-*.tgz \
  -C ${BOSH_INSTALL_TARGET}/lib/

mkdir -p ${BOSH_INSTALL_TARGET}/lib/skills
tar xzf ${BOSH_COMPILE_TARGET}/openclaw/skills-bundle-*.tgz \
  -C ${BOSH_INSTALL_TARGET}/lib/skills/

PKG_DIR=${BOSH_INSTALL_TARGET}/lib/node_modules/openclaw

# Verify the entry point loads on this platform during compilation
echo "=== Verifying openclaw entry point ==="
echo "Node.js version: $(node --version)"
echo "Package dir: ${PKG_DIR}"
ls -la "${PKG_DIR}/dist/entry.js" 2>&1 || echo "dist/entry.js NOT FOUND"
ls -la "${PKG_DIR}/openclaw.mjs" 2>&1 || echo "openclaw.mjs NOT FOUND"
echo "package.json type field: $(node -e "console.log(require('${PKG_DIR}/package.json').type || 'undefined')")"

cd "${PKG_DIR}"
echo "--- Testing: node ./openclaw.mjs --version ---"
node ./openclaw.mjs --version 2>&1 || {
  echo "ERROR: openclaw.mjs failed (exit $?)"
  echo "Trying dist/entry.js..."
  node ./dist/entry.js --version 2>&1 || {
    echo "ERROR: dist/entry.js also failed (exit $?)"
    exit 1
  }
}
echo "=== Entry point verified ==="
cd "${BOSH_COMPILE_TARGET}"

# Create a CJS bootstrap wrapper that uses dynamic import() to load the ESM entry.
# This avoids Node.js ESM file resolution issues that can occur inside BPM containers.
cat > ${BOSH_INSTALL_TARGET}/lib/bootstrap.cjs <<'BOOTSTRAP'
const path = require('path');
const { pathToFileURL } = require('url');
const pkgDir = path.join(__dirname, 'node_modules', 'openclaw');
const entry = path.join(pkgDir, 'openclaw.mjs');
import(pathToFileURL(entry).href).catch(err => {
  process.stderr.write('OpenClaw bootstrap error: ' + err.stack + '\n');
  process.exit(1);
});
BOOTSTRAP

mkdir -p ${BOSH_INSTALL_TARGET}/bin
cat > ${BOSH_INSTALL_TARGET}/bin/openclaw <<'WRAPPER'
#!/bin/bash
export PATH=/var/vcap/packages/node22/bin:$PATH
# Tee stderr to persistent disk for crash debugging (BPM logs are lost on VM delete)
exec 2> >(tee -a /var/vcap/store/openclaw/logs/gateway-stderr.log >&2)
echo "$(date '+%Y-%m-%d %H:%M:%S') Starting openclaw: $*" >&2
exec node /var/vcap/packages/openclaw/lib/bootstrap.cjs "$@"
WRAPPER
chmod +x ${BOSH_INSTALL_TARGET}/bin/openclaw
