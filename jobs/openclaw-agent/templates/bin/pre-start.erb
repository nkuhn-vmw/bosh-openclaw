#!/bin/bash

set -eu

export PATH="/var/vcap/packages/node22/bin:/var/vcap/packages/openclaw/bin:$PATH"

STATE_DIR="<%= p('openclaw.state_dir') %>"

# Create state directory on persistent disk
mkdir -p "${STATE_DIR}"
mkdir -p "${STATE_DIR}/memory"
mkdir -p "${STATE_DIR}/skills"
mkdir -p "${STATE_DIR}/sessions"

# Set ownership and permissions
chown -R vcap:vcap "${STATE_DIR}"
chmod 0750 "${STATE_DIR}"

# Create log, run, and data directories
mkdir -p /var/vcap/sys/log/openclaw-agent
mkdir -p /var/vcap/sys/run/openclaw-agent
mkdir -p /var/vcap/data/openclaw-agent
mkdir -p "${STATE_DIR}/logs"
chown -R vcap:vcap /var/vcap/sys/log/openclaw-agent
chown -R vcap:vcap /var/vcap/sys/run/openclaw-agent
chown vcap:vcap /var/vcap/data/openclaw-agent
chown vcap:vcap "${STATE_DIR}/logs"

# OpenClaw 2026.2.25+ creates a per-user temp dir at /tmp/openclaw with mode 0700
# during startup. Running as root first would create it owned by root, locking out
# vcap. Pre-create with vcap ownership so both users can share it.
mkdir -p /tmp/openclaw
chown vcap:vcap /tmp/openclaw
chmod 0700 /tmp/openclaw

# Verify openclaw loads as root
echo "Testing openclaw --version (as root)..."
openclaw --version 2>&1 || { echo "ERROR: openclaw --version failed" >&2; exit 1; }

# Re-fix /tmp/openclaw ownership after root run (root may have re-created it)
chown vcap:vcap /tmp/openclaw

# Test that openclaw can load as vcap user (BPM runs processes as vcap)
echo "Testing openclaw --version as vcap..."
chpst -u vcap:vcap openclaw --version 2>&1 || { echo "ERROR: openclaw --version failed as vcap user" >&2; exit 1; }
