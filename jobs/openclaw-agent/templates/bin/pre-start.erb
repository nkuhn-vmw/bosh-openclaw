#!/bin/bash

set -eu

export PATH="/var/vcap/packages/node22/bin:/var/vcap/packages/openclaw/bin:$PATH"

STATE_DIR="<%= p('openclaw.state_dir') %>"

# Create state directory on persistent disk
mkdir -p "${STATE_DIR}"
mkdir -p "${STATE_DIR}/memory"
mkdir -p "${STATE_DIR}/skills"
mkdir -p "${STATE_DIR}/sessions"

# Set ownership and permissions
chown -R vcap:vcap "${STATE_DIR}"
chmod 0750 "${STATE_DIR}"

# Create log and run directories
mkdir -p /var/vcap/sys/log/openclaw-agent
mkdir -p /var/vcap/sys/run/openclaw-agent
chown -R vcap:vcap /var/vcap/sys/log/openclaw-agent
chown -R vcap:vcap /var/vcap/sys/run/openclaw-agent

# Verify openclaw wrapper works (fail pre-start if it doesn't)
echo "Testing openclaw wrapper..."
if ! openclaw --version >/dev/null 2>&1; then
  echo "ERROR: openclaw wrapper failed. Diagnostics:" >&2
  echo "Node.js: $(node --version 2>&1)" >&2
  echo "Wrapper contents:" >&2
  cat /var/vcap/packages/openclaw/bin/openclaw >&2
  echo "Bootstrap contents:" >&2
  cat /var/vcap/packages/openclaw/lib/bootstrap.cjs 2>&1 >&2 || echo "bootstrap.cjs NOT FOUND" >&2
  echo "Package dir listing:" >&2
  ls -la /var/vcap/packages/openclaw/lib/node_modules/openclaw/ 2>&1 >&2 || echo "package dir NOT FOUND" >&2
  echo "Attempting direct execution for error output:" >&2
  node /var/vcap/packages/openclaw/lib/bootstrap.cjs --version 2>&1 >&2 || true
  exit 1
fi
echo "openclaw wrapper OK: $(openclaw --version 2>&1)"
