#!/bin/bash

set -eu
export PATH="/var/vcap/packages/cf-cli/bin:${PATH}"

CF_API="<%= p('cf.api_url') %>"
CF_USER="<%= p('cf.admin_username') %>"
CF_PASSWORD="<%= p('cf.admin_password') %>"
BROKER_NAME="<%= p('broker.name') %>"

SSL_FLAG=""
<% if p('cf.skip_ssl_validation') %>
SSL_FLAG="--skip-ssl-validation"
<% end %>

echo "Logging in to Cloud Foundry at ${CF_API}..."
cf api "${CF_API}" ${SSL_FLAG}
cf auth "${CF_USER}" "${CF_PASSWORD}"

echo "Deregistering service broker '${BROKER_NAME}'..."

if cf service-brokers | grep -q "^${BROKER_NAME} "; then
  echo "Disabling service access..."
  cf disable-service-access openclaw || true

  echo "Purging service offerings..."
  cf purge-service-offering openclaw -f || true

  echo "Deleting service broker..."
  cf delete-service-broker "${BROKER_NAME}" -f

  echo "Service broker '${BROKER_NAME}' deregistered successfully."
else
  echo "Broker '${BROKER_NAME}' not found, nothing to deregister."
fi

# -----------------------------------------------------------------------
# Clean up GenAI marketplace service instance (if provisioned)
# -----------------------------------------------------------------------
echo "Cleaning up GenAI marketplace resources..."

if cf target -o "system" -s "openclaw-services" 2>/dev/null; then
  echo "Deleting GenAI service key..."
  cf delete-service-key "openclaw-genai" "openclaw-broker-key" -f 2>/dev/null || true

  echo "Deleting GenAI service instance..."
  cf delete-service "openclaw-genai" -f 2>/dev/null || true

  # Wait for service deletion (up to 120s)
  TIMEOUT=120
  ELAPSED=0
  while [ ${ELAPSED} -lt ${TIMEOUT} ]; do
    if ! cf service "openclaw-genai" 2>/dev/null | grep -qi "status:"; then
      break
    fi
    STATUS=$(cf service "openclaw-genai" 2>&1 | grep -i "status:" | head -1 | sed 's/.*status:[[:space:]]*//' | tr '[:upper:]' '[:lower:]')
    case "${STATUS}" in
      *"in progress"*|*progress*)
        echo "  Waiting for service deletion... (${ELAPSED}s)"
        sleep 10
        ELAPSED=$((ELAPSED + 10))
        ;;
      *)
        break
        ;;
    esac
  done

  echo "Deleting openclaw-services space..."
  cf delete-space "openclaw-services" -o "system" -f 2>/dev/null || true
else
  echo "Space 'openclaw-services' not found â€” nothing to clean up."
fi
