<%
  # Normalize AZs: service_network_az_multi_select may return a string (single AZ)
  # or an array. Ensure it's always an array for the Go broker.
  azs_raw = p("openclaw.broker.on_demand.az")
  azs_array = case azs_raw
    when Array then azs_raw
    when String then azs_raw.strip.empty? ? [] : [azs_raw.strip]
    else []
  end

  # Transform the on_demand.plans hash (from tile manifest) into an array
  # of Plan objects that the Go broker expects.
  # Tile provides: { "developer" => { "enabled" => true, "vm_type" => "small", ... }, ... }
  # Broker expects: [ { "name" => "developer", "vm_type" => "small", ... }, ... ]
  plans_hash = p("openclaw.broker.on_demand.plans")
  plans_array = if plans_hash.is_a?(Hash)
    plans_hash.select { |_, cfg| cfg.fetch("enabled", true) }.map do |name, cfg|
      # Normalize per-plan AZs: string type is comma-separated, array type is direct.
      # Falls back to global azs_array when plan has no AZ configured.
      raw_az = cfg["az"] || cfg["azs"] || cfg["az_multi_select"] || ""
      plan_azs = if raw_az.is_a?(Array)
        raw_az.map(&:to_s).reject(&:empty?)
      elsif raw_az.is_a?(String) && !raw_az.strip.empty?
        raw_az.split(',').map(&:strip).reject(&:empty?)
      else
        []
      end
      plan_azs = azs_array if plan_azs.empty?
      {
        "name" => name.to_s.tr('_', '-'),
        "description" => (cfg["plan_description"] || cfg["description"] || "").to_s,
        "vm_type" => cfg["vm_type"].to_s,
        "disk_type" => cfg["disk_type"].to_s,
        "azs" => plan_azs,
        "features" => {
          "browser" => cfg.fetch("browser_automation", false),
        },
        "metadata" => {
          "displayName" => name.to_s.tr('_', '-').split('-').map(&:capitalize).join(' '),
          "max_sessions" => cfg.fetch("max_sessions", 1),
        },
      }
    end
  elsif plans_hash.is_a?(Array)
    plans_hash
  else
    []
  end
%>
<%= JSON.pretty_generate({
  "port" => p("openclaw.broker.port"),
  "auth" => {
    "username" => p("openclaw.broker.auth.username"),
    "password" => p("openclaw.broker.auth.password")
  },
  "tls" => {
    "enabled" => p("openclaw.broker.tls.enabled"),
    "certificate" => p("openclaw.broker.tls.certificate", ""),
    "private_key" => p("openclaw.broker.tls.private_key", "")
  },
  "bosh" => {
    "director_url" => p("openclaw.broker.bosh.director_url"),
    "uaa_url" => p("openclaw.broker.bosh.uaa_url", ""),
    "client_id" => p("openclaw.broker.bosh.client_id"),
    "client_secret" => p("openclaw.broker.bosh.client_secret"),
    "ca_cert" => p("openclaw.broker.bosh.ca_cert", "")
  },
  "agent_defaults" => {
    "openclaw_version" => p("openclaw.broker.agent_defaults.openclaw_version"),
    "stemcell" => p("openclaw.broker.agent_defaults.stemcell"),
    "network" => p("openclaw.broker.agent_defaults.network"),
    "az" => p("openclaw.broker.agent_defaults.az", "")
  },
  "genai" => {
    "provider" => p("openclaw.broker.genai.provider", ""),
    "endpoint" => p("openclaw.broker.genai.endpoint", ""),
    "api_key" => p("openclaw.broker.genai.api_key", ""),
    "model" => p("openclaw.broker.genai.model", ""),
    "preferred_model" => p("openclaw.broker.preferred_model", ""),
    "api_endpoint" => p("openclaw.broker.genai.api_endpoint", ""),
    "offering_name" => p("openclaw.broker.genai.offering_name", ""),
    "plan_name" => p("openclaw.broker.genai.plan_name", "")
  },
  "nats" => {
    "tls" => {
      "enabled" => p("openclaw.broker.nats.tls.enabled"),
      "client_cert" => p("openclaw.broker.nats.tls.client_cert", ""),
      "client_key" => p("openclaw.broker.nats.tls.client_key", ""),
      "ca_cert" => p("openclaw.broker.nats.tls.ca_cert", "")
    }
  },
  "on_demand" => {
    "service_name" => p("openclaw.broker.on_demand.service_name"),
    "plans" => plans_array,
    "stemcell_os" => p("openclaw.broker.on_demand.stemcell_os"),
    "stemcell_version" => p("openclaw.broker.on_demand.stemcell_version"),
    "network" => p("openclaw.broker.on_demand.network", ""),
    "azs" => azs_array,
    "openclaw_release_version" => p("openclaw.broker.on_demand.openclaw_release_version", "latest"),
    "bpm_release_version" => p("openclaw.broker.on_demand.bpm_release_version", "1.1.21"),
    "routing_release_version" => p("openclaw.broker.on_demand.routing_release_version", "0.283.0")
  },
  "cf" => {
    "system_domain" => p("openclaw.broker.cf.system_domain", ""),
    "apps_domain" => p("openclaw.broker.cf.apps_domain", ""),
    "deployment_name" => p("openclaw.broker.cf.deployment_name", ""),
    "api_url" => p("openclaw.broker.cf.api_url", ""),
    "admin_username" => p("openclaw.broker.cf.admin_username", ""),
    "admin_password" => p("openclaw.broker.cf.admin_password", ""),
    "skip_ssl_validation" => p("openclaw.broker.cf.skip_ssl_validation", true)
  },
  "cf_uaa" => {
    "url" => p("openclaw.broker.cf_uaa.url", ""),
    "admin_client_id" => p("openclaw.broker.cf_uaa.admin_client_id", "admin"),
    "admin_client_secret" => p("openclaw.broker.cf_uaa.admin_client_secret", "")
  },
  "security" => {
    "sandbox_mode" => p("openclaw.broker.security.sandbox_mode"),
    "blocked_commands" => p("openclaw.broker.security.blocked_commands", ""),
    "min_openclaw_version" => p("openclaw.broker.security.min_openclaw_version", ""),
    "sso_enabled" => p("openclaw.broker.security.sso_enabled", false),
    "sso_oidc_issuer_url" => p("openclaw.broker.security.sso_oidc_issuer_url", ""),
    "sso_allowed_email_domains" => p("openclaw.broker.security.sso_allowed_email_domains", ""),
    "sso_session_timeout_hours" => p("openclaw.broker.security.sso_session_timeout_hours", 8)
  },
  "metering" => {
    "enabled" => p("openclaw.broker.metering.enabled"),
    "export_interval_minutes" => p("openclaw.broker.metering.export_interval_minutes")
  },
  "limits" => {
    "max_instances" => p("openclaw.broker.limits.max_instances"),
    "max_instances_per_org" => p("openclaw.broker.limits.max_instances_per_org")
  }
}) %>
